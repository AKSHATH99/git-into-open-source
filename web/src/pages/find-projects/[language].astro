---
import DefaultLayout from '../../layouts/DefaultLayout.astro'
import fetch from 'node-fetch';
import { languages, repoTags } from './languages'
import RepoList from './RepoList.svelte';
import LanguageHeader from './LanguageHeader.svelte';

const { language } = Astro.params;

let repos = [];

const currentLanguage = languages.find((lang) => lang.identifier === language);

export async function getStaticPaths() {
  return languages.map((lang) => {
    return { params: { language: lang.identifier } }
  });
}

// const API_KEY = process.env.GH_ACCESS_TOKEN;

// const fetchRepos = async () => {
//   // first-timers-only
//   const url = `https://api.github.com/search/repositories?q=language:${language}&sort=stars&order=desc`;
//   const data = fetch(url, { headers: { 'Authorization': `token ${API_KEY}`}} );
//   const result = await (await data).json();
//   return result?.items || [];
// };

const fetchRepos = async (language, API_KEY) => {
    if (!language || !API_KEY) {
        throw new Error("Both language and API_KEY are required.");
    }

    const TIMEOUT = 10000;
    const topicQuery = repoTags.map(topic => `topic:${topic}`).join('+OR+');
    const url = `https://api.github.com/search/repositories?q=language:${language}+${topicQuery}&sort=stars&order=desc`;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);

    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${API_KEY}`,
                'Accept': 'application/vnd.github.mercy-preview+json'
            },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`GitHub API returned status code ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        return result?.items || [];
    } catch (error) {
        if (error.name === 'AbortError') {
            throw new Error("Request timed out.");
        }
        throw error; // Re-throw other errors
    }
};

repos = await fetchRepos(currentLanguage.identifier, process.env.GH_ACCESS_TOKEN);

---

<DefaultLayout name="Find a Project">
  <section class="wrapper">
    <a href="/find-projects" class="back">â†© Back</a>
    { language && 
    <>
      <LanguageHeader language={currentLanguage} />
      <RepoList repos={repos} />
    </>
    }
  </section>
</DefaultLayout>

<style lang="scss">
  .wrapper {
    max-width: 90vw;
    margin: 1rem auto;
    .back {
      color: var(--font-color-pale);
      border: 1px solid var(--font-color-pale);
      text-decoration: none;
      border-radius: 4px;
      padding: 0.1rem 0.25rem;
      margin-bottom: 0.5rem;
      display: block;
      width: fit-content;
      transition: 0.15s all ease-in-out;
      &:hover {
        background: var(--font-color-pale);
        color: var(--background);
      }
    }
  }

</style>
